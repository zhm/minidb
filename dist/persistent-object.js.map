{"version":3,"sources":["../src/persistent-object.js"],"names":["models","checkDatabase","db","PersistentObject","constructor","attributes","initializePersistentObject","_db","rowID","_rowID","updateFromDatabaseAttributes","findFirstColumns","ModelClass","columns","findFirstByAttributes","tableName","findFirst","row","instance","findAllColumns","findAllByAttributes","findAllBySQL","sql","values","rows","all","map","findAll","orderBy","findEachBySQL","params","callback","each","index","findEach","options","findEachByAttributes","findOrCreate","create","count","result","modelMethods","slice","register","modelClass","push","includeInto","wrap","method","args","concat","apply","column","simple","varName","name","customType","CUSTOM_TYPES","type","customGetter","getter","customSetter","setter","Object","defineProperty","prototype","get","set","value","enumerable","configurable","assignAttributes","_assignAttributes","key","keys","columnsByAttributeName","_buildColumns","byColumnName","_columnsByColumnName","byAttributeName","_columnsByAttributeName","columnsByColumnName","_updateFromDatabaseAttributes","fromDatabase","Error","objectCreatedAt","created_at","objectUpdatedAt","updated_at","toNumber","id","databaseValues","toDatabase","integer","updateTimestamps","now","Date","_objectCreatedAt","_objectUpdatedAt","date","isPersisted","save","timestamps","rest","beforeSave","insert","pk","update","afterSave","delete","beforeDelete","afterDelete","loadOne","model","ivar","setOne"],"mappings":"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","file":"persistent-object.js","sourcesContent":["import {format} from 'util';\nimport Mixin from 'mixmatch';\nimport assert from 'assert';\nimport Database from './database';\n\nconst models = [];\n\nfunction checkDatabase(db) {\n  assert(db instanceof Database, 'invalid db');\n}\n\nexport default class PersistentObject extends Mixin {\n  constructor(db, attributes) {\n    super();\n\n    this.initializePersistentObject(db, attributes);\n  }\n\n  get db() {\n    return this._db;\n  }\n\n  get rowID() {\n    return this._rowID;\n  }\n\n  initializePersistentObject(db, attributes) {\n    this._db = db;\n\n    this.updateFromDatabaseAttributes(attributes || {}, db);\n\n    return this;\n  }\n\n  static async findFirstColumns(ModelClass, db, attributes, columns) {\n    return await db.findFirstByAttributes(ModelClass.tableName, columns, attributes);\n  }\n\n  static async findFirst(ModelClass, db, attributes) {\n    const row = await db.findFirstByAttributes(ModelClass.tableName, null, attributes);\n\n    if (row) {\n      const instance = new ModelClass();\n\n      instance.initializePersistentObject(db, row);\n\n      return instance;\n    }\n\n    return null;\n  }\n\n  static async findAllColumns(ModelClass, db, attributes, columns) {\n    return await db.findAllByAttributes(ModelClass.tableName, columns, attributes);\n  }\n\n  static async findAllBySQL(ModelClass, db, sql, values) {\n    const rows = await db.all(sql, values);\n\n    return rows.map((row) => {\n      const instance = new ModelClass();\n\n      instance.initializePersistentObject(db, row);\n\n      return instance;\n    });\n  }\n\n  static async findAll(ModelClass, db, attributes, orderBy) {\n    const rows = await db.findAllByAttributes(ModelClass.tableName, null, attributes, orderBy);\n\n    return rows.map((row) => {\n      const instance = new ModelClass();\n\n      instance.initializePersistentObject(db, row);\n\n      return instance;\n    });\n  }\n\n  static findEachBySQL(ModelClass, db, sql, params, callback) {\n    return db.each(sql, params, async ({columns, values, index}) => {\n      if (values) {\n        const instance = new ModelClass();\n\n        instance.initializePersistentObject(db, values);\n\n        return await callback(instance, {columns, values, index});\n      }\n\n      return null;\n    });\n  }\n\n  static findEach(ModelClass, db, options, callback) {\n    return db.findEachByAttributes({tableName: ModelClass.tableName, ...options}, async ({columns, values, index}) => {\n      if (values) {\n        const instance = new ModelClass();\n\n        instance.initializePersistentObject(db, values);\n\n        return await callback(instance, {columns, values, index});\n      }\n\n      return null;\n    });\n  }\n\n  static async findOrCreate(ModelClass, db, attributes) {\n    const row = await db.findFirstByAttributes(ModelClass.tableName, null, attributes);\n\n    const instance = new ModelClass();\n\n    instance.initializePersistentObject(db, {...row, ...attributes});\n\n    return instance;\n  }\n\n  static create(ModelClass, db, attributes) {\n    const instance = new ModelClass();\n\n    instance.initializePersistentObject(db, attributes);\n\n    return instance;\n  }\n\n  static async count(ModelClass, db, attributes) {\n    const result = await db.findFirstByAttributes(ModelClass.tableName, [ 'COUNT(1) AS count' ], attributes);\n\n    return result.count;\n  }\n\n  static get modelMethods() {\n    return [ 'findFirst', 'findFirstColumns', 'findAll', 'findAllBySQL', 'findAllColumns', 'findEach', 'findEachBySQL', 'findOrCreate', 'create', 'count' ];\n  }\n\n  static get models() {\n    return models.slice();\n  }\n\n  static register(modelClass) {\n    models.push(modelClass);\n\n    PersistentObject.includeInto(modelClass);\n\n    const wrap = (method) => {\n      return (...params) => {\n        const args = [ modelClass ].concat(params);\n        return PersistentObject[method].apply(PersistentObject, args);\n      };\n    };\n\n    for (const method of PersistentObject.modelMethods) {\n      modelClass[method] = wrap(method);\n    }\n\n    for (const column of modelClass.columns) {\n      if (column.simple) {\n        const varName = '_' + column.name;\n\n        const customType = Database.CUSTOM_TYPES[column.type];\n\n        const customGetter = customType && customType.getter ? customType.getter({varName, column}) : null;\n        const customSetter = customType && customType.setter ? customType.setter({varName, column}) : null;\n\n        Object.defineProperty(modelClass.prototype, column.name, {\n          get: customGetter || function getter() {\n            return this[varName];\n          },\n          set: customSetter || function setter(value) {\n            this[varName] = value;\n          },\n          enumerable: true,\n          configurable: true\n        });\n      }\n    }\n  }\n\n  assignAttributes(attributes) {\n    this._assignAttributes(attributes);\n  }\n\n  _assignAttributes(attributes) {\n    for (const key of Object.keys(attributes)) {\n      const column = this.columnsByAttributeName[key];\n\n      if (column) {\n        if (column.simple) {\n          // use the setter\n          this[column.name] = attributes[column.name];\n        } else {\n          this['_' + column.name] = attributes[column.name];\n        }\n      }\n    }\n  }\n\n  _buildColumns() {\n    const byColumnName = this.constructor._columnsByColumnName = {};\n    const byAttributeName = this.constructor._columnsByAttributeName = {};\n\n    for (const column of this.constructor.columns) {\n      byColumnName[column.column] = column;\n      byAttributeName[column.name] = column;\n    }\n  }\n\n  get columnsByColumnName() {\n    if (!this.constructor._columnsByColumnName) {\n      this._buildColumns();\n    }\n    return this.constructor._columnsByColumnName;\n  }\n\n  get columnsByAttributeName() {\n    if (!this.constructor._columnsByAttributeName) {\n      this._buildColumns();\n    }\n    return this.constructor._columnsByAttributeName;\n  }\n\n  updateFromDatabaseAttributes(attributes, db) {\n    this._updateFromDatabaseAttributes(attributes, db || this.db);\n  }\n\n  _updateFromDatabaseAttributes(attributes, db) {\n    db = db || this.db;\n\n    checkDatabase(db);\n\n    for (const key of Object.keys(attributes)) {\n      const column = this.columnsByColumnName[key];\n\n      const value = column && db.fromDatabase(attributes[column.column], column);\n\n      if (column && column.simple) {\n        // call the setter\n        this[column.name] = value;\n      } else if (column) {\n        this['_' + column.name] = value;\n      } else if (key !== 'id' && key !== 'created_at' && key !== 'updated_at') {\n        throw new Error(format(\"column definition for '%s' does not exist\", key));\n      }\n    }\n\n    this.objectCreatedAt = db.fromDatabase(attributes.created_at, {type: 'datetime'});\n    this.objectUpdatedAt = db.fromDatabase(attributes.updated_at, {type: 'datetime'});\n\n    this._rowID = this.toNumber(attributes.id);\n  }\n\n  attributes() {\n    const values = {};\n\n    for (const column of this.constructor.columns) {\n      const name = column.name;\n\n      values['_' + name] = this['_' + name];\n    }\n\n    return values;\n  }\n\n  databaseValues(db) {\n    db = db || this.db;\n\n    checkDatabase(db);\n\n    const values = {};\n\n    for (const column of this.constructor.columns) {\n      const name = column.name;\n      const value = this['_' + name];\n\n      // TODO(zhm) this doesn't work with the id attribute\n      // if (value == null && column.null === false) {\n      //   throw Error(format('column %s cannot be null', name));\n      // }\n\n      values[column.column] = db.toDatabase(value, column);\n    }\n\n    return values;\n  }\n\n  toNumber(integer) {\n    return integer != null ? +integer : null;\n  }\n\n  updateTimestamps() {\n    const now = new Date();\n\n    if (!this.objectCreatedAt) {\n      this.objectCreatedAt = now;\n    }\n\n    this.objectUpdatedAt = now;\n  }\n\n  get objectCreatedAt() {\n    return this._objectCreatedAt;\n  }\n\n  get objectUpdatedAt() {\n    return this._objectUpdatedAt;\n  }\n\n  set objectCreatedAt(date) {\n    this._objectCreatedAt = date;\n  }\n\n  set objectUpdatedAt(date) {\n    this._objectUpdatedAt = date;\n  }\n\n  get isPersisted() {\n    return this.rowID > 0;\n  }\n\n  async save({db, timestamps, ...rest} = {}) {\n    db = db || this.db;\n\n    checkDatabase(db);\n\n    if (this.beforeSave) {\n      const result = await this.beforeSave({db, timestamps, ...rest});\n\n      if (result === false) {\n        return this;\n      }\n    }\n\n    if (timestamps !== false) {\n      this.updateTimestamps();\n    }\n\n    const values = this.databaseValues(db);\n\n    values.created_at = db.toDatabase(this.objectCreatedAt, {type: 'datetime'});\n    values.updated_at = db.toDatabase(this.objectUpdatedAt, {type: 'datetime'});\n\n    if (!this.isPersisted) {\n      this._rowID = await db.insert(this.constructor.tableName, values, {pk: 'id'});\n    } else {\n      await db.update(this.constructor.tableName, {id: this.rowID}, values);\n    }\n\n    if (this.afterSave) {\n      await this.afterSave({db, timestamps, ...rest});\n    }\n\n    return this;\n  }\n\n  async delete({db, ...rest} = {}) {\n    db = db || this.db;\n\n    checkDatabase(db);\n\n    if (this.isPersisted) {\n      if (this.beforeDelete) {\n        const result = await this.beforeDelete({db, ...rest});\n\n        if (result === false) {\n          return this;\n        }\n      }\n\n      await db.delete(this.constructor.tableName, {id: this.rowID});\n\n      if (this.afterDelete) {\n        await this.afterDelete({db, ...rest});\n      }\n\n      this._rowID = null;\n      this.objectCreatedAt = null;\n      this.objectUpdatedAt = null;\n    }\n\n    return this;\n  }\n\n  async loadOne(name, model, id, db) {\n    db = db || this.db;\n\n    checkDatabase(db);\n\n    const ivar = '_' + name;\n\n    const pk = id || this[ivar + 'RowID'];\n\n    if (pk == null) {\n      return null;\n    }\n\n    if (this[ivar]) {\n      return this[ivar];\n    }\n\n    const instance = await model.findFirst(db, {id: pk});\n\n    this.setOne(name, instance);\n\n    return this[ivar];\n  }\n\n  setOne(name, instance) {\n    const ivar = '_' + name;\n\n    if (instance) {\n      this[ivar] = instance;\n      this[ivar + 'ID'] = instance.id;\n      this[ivar + 'RowID'] = instance.rowID;\n    } else {\n      this[ivar] = null;\n      this[ivar + 'ID'] = null;\n      this[ivar + 'RowID'] = null;\n    }\n  }\n}\n"]}